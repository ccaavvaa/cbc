{"version":3,"sources":["../../src/lib/server.ts"],"names":[],"mappings":";;AAEA,iCAA+B;AAG/B;CAGC;AAED;IAAA;QACY,cAAS,GAAsB,EAAE,CAAC;QAClC,WAAM,GAAG,CAAC,CAAC;IAsDvB,CAAC;IApDU,KAAK,CAAC,OAAO,CAAC,IAAU;QAC3B,IAAI,CAAO,CAAC;QACZ,EAAE,CAAC,CAAC,YAAK,CAAC,eAAe,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;YAC9B,MAAM,QAAQ,GAAa;gBACvB,IAAI,EAAE,IAAI,CAAC,KAAK;aACnB,CAAC;YACF,EAAE,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,UAAU,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC;gBAC7B,MAAM,WAAW,GAAG;oBAChB,EAAE,EAAE,IAAI,CAAC,MAAM,EAAE;oBACjB,KAAK,EAAE,IAAI,CAAC,KAAK;iBACpB,CAAC;gBACF,MAAM,SAAS,GAAG,MAAM,IAAI,CAAC,WAAW,CAAC,WAAW,CAAC,CAAC;gBACtD,EAAE,CAAC,CAAC,SAAS,CAAC,SAAS,KAAK,WAAW,CAAC,EAAE,CAAC,CAAC,CAAC;oBACzC,QAAQ,CAAC,OAAO,GAAG,IAAI,CAAC;oBACxB,QAAQ,CAAC,IAAI,GAAG,MAAM,GAAG,QAAQ,CAAC,IAAI,CAAC;gBAC3C,CAAC;gBACD,QAAQ,CAAC,IAAI,GAAG,QAAQ,CAAC,IAAI,GAAG,GAAG,GAAG,SAAS,CAAC,IAAI,CAAC;YACzD,CAAC;YACD,CAAC,GAAG,QAAQ,CAAC;QACjB,CAAC;QAAC,IAAI,CAAC,CAAC;YACJ,MAAM,eAAe,GAAG,IAAI,CAAC,SAAS,CAAC,GAAG,EAAE,CAAC;YAC7C,MAAM,CAAC,IAAI,OAAO,CAAO,CAAC,OAAO,EAAE,MAAM,EAAE,EAAE;gBACzC,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC;oBAChB,OAAO;oBACP,MAAM;iBACT,CAAC,CAAC;gBACH,eAAe,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC;YAClC,CAAC,CAAC,CAAC;QACP,CAAC;IACL,CAAC;IACM,WAAW,CAAC,OAAgB;QAC/B,MAAM,eAAe,GAAG,IAAI,CAAC,SAAS,CAAC,GAAG,EAAE,CAAC;QAC7C,MAAM,CAAC,IAAI,OAAO,CAAW,CAAC,OAAO,EAAE,MAAM,EAAE,EAAE;YAC7C,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC;gBAChB,OAAO;gBACP,MAAM;aACT,CAAC,CAAC;YACH,eAAe,CAAC,OAAO,CAAC,OAAO,CAAC,CAAC;QACrC,CAAC,CAAC,CAAC;IACP,CAAC;IACM,OAAO,CAAC,IAAU;QACrB,MAAM,eAAe,GAAG,IAAI,OAAO,CAAO,CAAC,OAAO,EAAE,MAAM,EAAE,EAAE;YAC1D,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,EAAE,OAAO,EAAE,MAAM,EAAE,CAAC,CAAC;YACzC,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC;iBACb,IAAI,CAAC,CAAC,CAAC,EAAE,EAAE;gBACR,MAAM,eAAe,GAAG,IAAI,CAAC,SAAS,CAAC,GAAG,EAAE,CAAC;gBAC7C,eAAe,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC;YAC/B,CAAC,CAAC,CAAC;QACX,CAAC,CAAC,CAAC;QACH,MAAM,CAAC,eAAe,CAAC;IAC3B,CAAC;CAEJ;AAxDD,wBAwDC","file":"server.js","sourcesContent":["import { Request } from './request';\nimport { Response } from './response';\nimport { Tools } from './util';\n\nexport type Data = Request | Response;\nclass PromiseResolver {\n    public resolve: (value?: Data | PromiseLike<Data>) => void;\n    public reject: (reason?: any) => void;\n}\n\nexport class Server {\n    private executors: PromiseResolver[] = [];\n    private nextId = 1;\n\n    public async execute(data: Data): Promise<Data> {\n        let r: Data;\n        if (Tools.objectIsRequest(data)) {\n            const response: Response = {\n                data: data.query,\n            };\n            if (data.query.startsWith('q')) {\n                const clientQuery = {\n                    id: this.nextId++,\n                    query: data.query,\n                };\n                const queryData = await this.queryClient(clientQuery);\n                if (queryData.requestId !== clientQuery.id) {\n                    response.isError = true;\n                    response.data = 'err ' + response.data;\n                }\n                response.data = response.data + ':' + queryData.data;\n            }\n            r = response;\n        } else {\n            const currentResolver = this.executors.pop();\n            return new Promise<Data>((resolve, reject) => {\n                this.executors.push({\n                    resolve,\n                    reject,\n                });\n                currentResolver.resolve(data);\n            });\n        }\n    }\n    public queryClient(request: Request): Promise<Response> {\n        const currentResolver = this.executors.pop();\n        return new Promise<Response>((resolve, reject) => {\n            this.executors.push({\n                resolve,\n                reject,\n            });\n            currentResolver.resolve(request);\n        });\n    }\n    public process(data: Data): Promise<Data> {\n        const responsePromise = new Promise<Data>((resolve, reject) => {\n            this.executors.push({ resolve, reject });\n            this.execute(data)\n                .then((r) => {\n                    const currentResolver = this.executors.pop();\n                    currentResolver.resolve(r);\n                });\n        });\n        return responsePromise;\n    }\n\n}\n"]}